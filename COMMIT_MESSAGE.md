fix: 代码审查问题修复与补充 - 安全性、性能和代码质量全面提升

本次提交修复了代码审查中发现的所有 P0、P1 和 P2 级别问题，以及补充审查中发现的遗漏问题，共计修复 16 个问题。

## 🔴 严重问题修复 (P0 - 6个)

### 安全性增强
- **task_id 路径遍历风险**: 创建 `app/utils/security.py` 模块，所有使用 `task_id` 的端点添加 UUID 格式验证
- **删除操作路径安全验证**: 使用 `validate_path_in_storage()` 确保删除路径在安全范围内
- **路径遍历防护**: 改进图片访问端点的路径验证，只使用文件名并添加格式验证
- **异常信息泄露**: 根据日志级别决定是否返回详细错误信息，避免泄露敏感信息

### 性能优化
- **API Key 验证优化**: 从 `request.app.state` 获取 settings，使用 set 进行 O(1) 查找
- **临时文件清理**: 使用 `shutil.rmtree()` 确保完全清理临时目录

## 🟡 重要问题修复 (P1 - 7个)

### 资源管理
- **NVML 初始化优化**: 使用全局状态管理，避免重复初始化/关闭
- **文件上传原子写入**: 使用临时文件 + 原子替换，确保文件完整性

### 并发安全
- **队列竞态条件修复**: 队列满时回滚已添加的 job，避免内存泄漏
- **RateLimiter 后台清理**: 添加后台线程定期清理过期 bucket，减少主线程开销

### 性能优化
- **Token 管理 I/O 优化**: 使用后台线程批量写入，减少高并发下的文件 I/O 瓶颈
- **JSON 写入效率优化**: 写入前检查内容是否相同，避免不必要的磁盘操作
- **Image.open DoS 防护**: 添加图片尺寸限制（8192x8192），防止内存耗尽攻击

### 代码质量
- **vLLM 魔法数字提取**: 统一使用 `DEFAULT_DPI` 常量替代硬编码

## 🟢 代码质量改进 (P2 - 3个)

- **魔法数字提取**: 提取硬编码数值为常量（DPI、图像质量等）
- **配置验证增强**: 添加 5 个配置验证器，防止不合理的配置值
- **日志级别优化**: 根据响应状态码选择适当的日志级别

## 📊 修复统计

- 严重问题 (P0): 6 个 ✅
- 重要问题 (P1): 7 个 ✅
- 代码质量 (P2): 3 个 ✅
- 总计: 16 个问题全部修复 ✅

## 🎯 修复效果

1. **安全性大幅提升**:
   - 所有路径操作都有验证，防止路径遍历攻击
   - task_id 格式验证，防止恶意输入
   - 异常信息不再泄露敏感信息

2. **性能优化**:
   - API Key 验证性能提升（O(1) 查找）
   - Token I/O 异步化，减少高并发下的文件 I/O 瓶颈
   - RateLimiter 后台清理，减少主线程开销
   - JSON 写入优化，避免不必要的磁盘操作

3. **稳定性提升**:
   - 文件上传原子写入，确保文件完整性
   - 队列竞态条件修复，避免内存泄漏
   - 临时文件清理改进，防止资源泄漏

4. **DoS 防护**:
   - 图片尺寸限制防止内存耗尽攻击
   - NVML 初始化优化避免重复初始化开销

5. **代码质量**:
   - 统一使用常量，减少魔法数字
   - 日志级别优化，提供更精确的日志信息
   - 配置验证增强，防止不合理的配置

## 📝 影响范围

### 新增文件
- `app/utils/security.py`: 安全工具函数模块（task_id 验证、路径验证）

### 修改文件
- `app/api/v1/tasks.py`: 路径遍历防护、文件上传原子写入、task_id 验证
- `app/api/v1/publish.py`: task_id 验证、路径验证
- `app/api/v1/infer.py`: 异常信息泄露修复、魔法数字提取
- `app/security/auth.py`: API Key 验证性能优化
- `app/security/rate_limit.py`: 后台清理优化
- `app/security/tokens.py`: 异步 I/O 优化
- `app/utils/gpu.py`: NVML 全局状态管理
- `app/services/queue.py`: 队列竞态条件修复
- `app/services/dsocr_model.py`: 临时文件清理、魔法数字提取、图片 DoS 防护
- `app/services/dsocr_vllm.py`: 魔法数字提取、图片 DoS 防护
- `app/storage/local.py`: JSON 写入效率优化
- `app/config.py`: 配置验证增强
- `app/middleware.py`: 日志级别优化

## 🔗 相关文档

- 详细修复说明: `docs/FIXES_SUMMARY.md`
- 代码审查报告: `docs/CODE_REVIEW.md`
- 补充审查报告: `docs/CODE_REVIEW_ADDITIONAL.md`
